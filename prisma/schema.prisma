generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────

enum Rarity {
  N
  R
  SR
  SSR
  UR
}

enum Category {
  sneaker
  card
  figure
  game
  other
}

enum UserRank {
  BEGINNER
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
  VIP
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OwnedItemStatus {
  OWNED
  EXCHANGE_REQUESTED
  EXCHANGED
  SHIPPING_REQUESTED
  SHIPPING
  SHIPPED
  DELIVERED
}

enum PackStatus {
  DRAFT
  ACTIVE
  ENDED
  SOLD_OUT
}

enum ShipmentStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  RETURNED
}

enum ChargeStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  CONVENIENCE_STORE
  BANK_TRANSFER
  PAYPAY
}

// ─── Auth / User ──────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  email          String?   @unique
  emailVerified  DateTime?
  name           String?
  image          String?
  hashedPassword String?
  phone          String?
  phoneVerified  Boolean   @default(false)
  ageVerified    Boolean   @default(false)
  role           UserRole  @default(USER)
  rank           UserRank  @default(BEGINNER)
  coins          Int       @default(0)
  totalSpent     Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // App relations
  draws             Draw[]
  ownedItems        OwnedItem[]
  coinTransactions  CoinTransaction[]
  chargeOrders      ChargeOrder[]
  shippingAddresses ShippingAddress[]
  shipments         Shipment[]

  @@index([email])
  @@index([rank])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Oripa / Gacha ────────────────────────────────────

model OripaPack {
  id             String     @id @default(cuid())
  title          String
  description    String
  image          String
  category       Category
  pricePerDraw   Int
  totalStock     Int
  remainingStock Int
  status         PackStatus @default(DRAFT)
  featured       Boolean    @default(false)
  limitPerUser   Int?
  startsAt       DateTime?
  endsAt         DateTime?
  lastOnePrizeId String?
  sortOrder      Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  lastOnePrize Prize?      @relation("LastOnePrize", fields: [lastOnePrizeId], references: [id])
  packPrizes   PackPrize[]
  draws        Draw[]

  @@index([status, category])
  @@index([status, sortOrder])
  @@index([featured])
}

model Prize {
  id          String @id @default(cuid())
  name        String
  description String @default("")
  image       String
  rarity      Rarity
  marketPrice Int
  coinValue   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  packPrizes     PackPrize[]
  draws          Draw[]
  ownedItems     OwnedItem[]
  lastOnePacks   OripaPack[] @relation("LastOnePrize")

  @@index([rarity])
}

model PackPrize {
  id                String @id @default(cuid())
  packId            String
  prizeId           String
  weight            Int
  totalQuantity     Int
  remainingQuantity Int

  pack  OripaPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  prize Prize     @relation(fields: [prizeId], references: [id])
  draws Draw[]

  @@unique([packId, prizeId])
  @@index([packId])
}

model Draw {
  id          String   @id @default(cuid())
  userId      String?
  packId      String
  packPrizeId String
  prizeId     String
  coinsCost   Int
  isTrial     Boolean  @default(false)
  createdAt   DateTime @default(now())

  user      User?     @relation(fields: [userId], references: [id])
  pack      OripaPack @relation(fields: [packId], references: [id])
  packPrize PackPrize @relation(fields: [packPrizeId], references: [id])
  prize     Prize     @relation(fields: [prizeId], references: [id])
  ownedItem OwnedItem?

  @@index([userId, createdAt])
  @@index([packId, createdAt])
  @@index([createdAt])
}

// ─── Inventory / Shipping ─────────────────────────────

model OwnedItem {
  id         String          @id @default(cuid())
  userId     String
  prizeId    String
  drawId     String          @unique
  status     OwnedItemStatus @default(OWNED)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  user          User           @relation(fields: [userId], references: [id])
  prize         Prize          @relation(fields: [prizeId], references: [id])
  draw          Draw           @relation(fields: [drawId], references: [id])
  shipmentItems ShipmentItem[]

  @@index([userId, status])
}

model ShippingAddress {
  id         String  @id @default(cuid())
  userId     String
  label      String  @default("自宅")
  postalCode String
  prefecture String
  city       String
  address1   String
  address2   String?
  phone      String
  isDefault  Boolean @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  shipments Shipment[]

  @@index([userId])
}

model Shipment {
  id               String         @id @default(cuid())
  userId           String
  shippingAddressId String
  status           ShipmentStatus @default(PENDING)
  trackingNumber   String?
  carrier          String?
  shippingFee      Int            @default(0)
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  user            User            @relation(fields: [userId], references: [id])
  shippingAddress ShippingAddress @relation(fields: [shippingAddressId], references: [id])
  items           ShipmentItem[]

  @@index([userId, status])
  @@index([status])
}

model ShipmentItem {
  id          String @id @default(cuid())
  shipmentId  String
  ownedItemId String

  shipment  Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  ownedItem OwnedItem @relation(fields: [ownedItemId], references: [id])

  @@unique([shipmentId, ownedItemId])
}

// ─── Coins / Payment ──────────────────────────────────

model ChargePlan {
  id            String  @id @default(cuid())
  coins         Int
  price         Int
  bonus         Int     @default(0)
  isPopular     Boolean @default(false)
  firstTimeOnly Boolean @default(false)
  isActive      Boolean @default(true)
  sortOrder     Int     @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  chargeOrders ChargeOrder[]

  @@index([isActive, sortOrder])
}

model ChargeOrder {
  id                String        @id @default(cuid())
  userId            String
  chargePlanId      String
  coins             Int
  amount            Int
  bonus             Int           @default(0)
  status            ChargeStatus  @default(PENDING)
  paymentMethod     PaymentMethod @default(CREDIT_CARD)
  stripePaymentId   String?       @unique
  stripeSessionId   String?       @unique
  paypayOrderId     String?       @unique
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  chargePlan ChargePlan @relation(fields: [chargePlanId], references: [id])

  @@index([userId, createdAt])
  @@index([status])
}

model CoinTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  balance     Int
  type        String   // CHARGE, DRAW, EXCHANGE, REFUND, BONUS, ADMIN_ADJUST
  description String
  referenceId String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([type])
}

// ─── Admin ────────────────────────────────────────────

model AdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([adminId, createdAt])
  @@index([resource, resourceId])
  @@index([createdAt])
}
